<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinMango Trends Analyzer</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        /* Keep all your existing CSS styles here - they remain unchanged */
        :root {
            --fm-orange: #FF8A2B;
            --fm-orange-light: #FFB067;
            --fm-orange-dark: #E66E00;
            --fm-green: #4CAF50;
            --fm-green-light: #7BC67E;
            --fm-green-dark: #3B8C3F;
            --surface-1: #FFFFFF;
            --surface-2: #F8F9FA;
            --surface-3: #F1F3F4;
            --surface-4: #E8EAED;
            --text-primary: #1D1B20;
            --text-secondary: #49454F;
            --text-tertiary: #79747E;
            --state-hover: rgba(255, 138, 43, 0.08);
            --state-focus: rgba(255, 138, 43, 0.12);
            --state-pressed: rgba(255, 138, 43, 0.16);
            --elevation-1: 0px 1px 3px rgba(0, 0, 0, 0.1);
            --elevation-2: 0px 4px 6px rgba(0, 0, 0, 0.1);
            --transition-speed: 200ms;
        }

        /* Your existing CSS styles remain the same */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--surface-2);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Include all other CSS styles from your original code */
        /* ... */
    </style>
</head>
<body>
    <!-- Keep your existing HTML structure -->
    <header class="top-app-bar">
        <span class="material-icons" style="color: var(--fm-orange); font-size: 32px;">trending_up</span>
        <h1 class="page-title">FinMango Trends Analyzer</h1>
    </header>

    <main class="container">
        <!-- Keep all your existing HTML content -->
        <!-- ... -->
    </main>

    <div id="toast" class="toast"></div>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Initialize variables
        let trendsData = [];
        const BACKEND_URL = 'https://finmango-trends-backend.onrender.com';

        // Initialize date pickers
        const today = new Date();
        const fifteenYearsAgo = new Date();
        fifteenYearsAgo.setFullYear(today.getFullYear() - 15);

        flatpickr('.date-picker', {
            maxDate: 'today',
            dateFormat: 'Y-m-d',
            onChange: function(selectedDates, dateStr, instance) {
                validateDateRange();
            }
        });

        // Initialize start and end dates
        document.getElementById('startDate').value = fifteenYearsAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];

        // Geographic data
        const geoData = {
            COUNTRY: {
                US: "United States",
                GB: "United Kingdom",
                CA: "Canada",
                AU: "Australia",
                IN: "India",
                DE: "Germany",
                FR: "France",
                BR: "Brazil",
                JP: "Japan",
                MX: "Mexico"
            },
            REGION: {
                "US-CA": "California",
                "US-NY": "New York",
                "US-TX": "Texas",
                "US-FL": "Florida",
                "US-IL": "Illinois",
                "US-PA": "Pennsylvania",
                "US-OH": "Ohio",
                "US-GA": "Georgia",
                "US-MI": "Michigan",
                "US-NC": "North Carolina"
            },
            DMA: {
                "501": "New York",
                "803": "Los Angeles",
                "807": "San Francisco-Oakland-San Jose",
                "602": "Chicago",
                "506": "Boston",
                "623": "Dallas-Fort Worth",
                "528": "Miami-Fort Lauderdale",
                "751": "Denver",
                "819": "Cleveland",
                "825": "San Diego"
            }
        };

        // Updated fetchTrendsData function to use backend
        async function fetchTrendsData(terms) {
            if (!validateDateRange()) {
                return;
            }

            const validTerms = terms.filter(term => term.trim() !== '');
            if (validTerms.length === 0) {
                showToast('Please enter at least one search term');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const geoType = document.getElementById('geoType').value;
            const geoValue = document.getElementById('geoValue').value;

            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                const params = new URLSearchParams({
                    terms: validTerms.join(','),
                    startDate: startDate,
                    endDate: endDate,
                    geo: geoType === 'GLOBAL' ? '' : geoValue
                });

                const response = await fetch(`${BACKEND_URL}/api/trends?${params}`);

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                trendsData = data.default.timelineData.map(point => ({
                    date: new Date(point.time * 1000).toLocaleDateString(),
                    ...point.value.reduce((acc, val, idx) => {
                        acc[`term${idx + 1}`] = val;
                        return acc;
                    }, {})
                }));

                displayData(trendsData);
                displayChart(trendsData);
            } catch (error) {
                console.error('Error:', error);
                showToast('Error fetching trends data. Please try again later.');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Keep all your existing helper functions
        function displayData(data) {
            const table = document.createElement('table');
            table.className = 'data-table';
            
            if (data.length === 0) {
                document.getElementById('trendsData').innerHTML = 'No data available';
                return;
            }

            // Create headers
            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.charAt(0).toUpperCase() + header.slice(1);
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // Create data rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });

            const dataDiv = document.getElementById('trendsData');
            dataDiv.innerHTML = '';
            dataDiv.appendChild(table);
        }

        function displayChart(data) {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                const dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'Date');
                
                // Add columns for each term
                const terms = Object.keys(data[0]).filter(key => key !== 'date');
                terms.forEach(term => {
                    dataTable.addColumn('number', term);
                });

                // Add rows
                const chartData = data.map(point => {
                    return [point.date, ...terms.map(term => point[term])];
                });
                dataTable.addRows(chartData);

                const options = {
                    title: 'Google Trends Data',
                    curveType: 'function',
                    legend: { position: 'bottom' },
                    colors: ['#FF8A2B', '#4CAF50', '#2196F3', '#9C27B0', '#FF5722'],
                    backgroundColor: '#FFFFFF',
                    chartArea: {
                        width: '80%',
                        height: '70%'
                    },
                    vAxis: {
                        title: 'Search Interest',
                        minValue: 0
                    },
                    hAxis: {
                        title: 'Date'
                    }
                };

                const chart = new google.visualization.LineChart(document.getElementById('trendsChart'));
                chart.draw(dataTable, options);
            });
        }

        function downloadCSV() {
            if (trendsData.length === 0) {
                showToast('No data available to download');
                return;
            }

            const headers = Object.keys(trendsData[0]);
            const csvRows = [
                headers.join(','),
                ...trendsData.map(row => headers.map(header => row[header]).join(','))
            ];

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trends_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        function validateDateRange() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (endDate < startDate) {
                showToast('End date must be after start date');
                return false;
            }

            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays > 5475) {
                showToast('Date range cannot exceed 15 years');
                return false;
            }

            return true;
        }

        function updateGeoOptions() {
            const geoType = document.getElementById('geoType').value;
            const geoSelect = document.getElementById('geoValue');
            geoSelect.innerHTML = '<option value="">Select area...</option>';
            
            if (geoType === 'GLOBAL') {
                geoSelect.disabled = true;
                return;
            }

            geoSelect.disabled = false;
            const options = geoData[geoType] || {};
            
            Object.entries(options).forEach(([value, label]) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                geoSelect.appendChild(option);
            });
        }

        // Handle preset date buttons
        document.getElementById('presetDates').addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-btn')) {
                const days = parseInt(e.target.dataset.days);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - days);
                
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        function updateTrends() {
            const terms = [
                document.getElementById('searchTerm1').value,
                document.getElementById('searchTerm2').value,
                document.getElementById('searchTerm3').value,
                document.getElementById('searchTerm4').value,
                document.getElementById('searchTerm5').value
            ].filter(term => term.trim() !== '');

            fetchTrendsData(terms);
        }

        // Initialize the page
        window.onload = function() {
            updateGeoOptions();
            document.getElementById('searchTerm1').value = 'financial literacy';
            // Test the backend connection
            fetch(`${BACKEND_URL}/health`)
                .then(response => response.json())
                .then(data => console.log('Backend status:', data))
                .catch(error => console.error('Backend connection error:', error));
        }
    </script>
</body>
</html>
